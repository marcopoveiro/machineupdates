- name: Verify connection to remote machines
  hosts: all
  become: yes
  tasks:
    - name: âœ… Connected to {{ inventory_hostname }}
      debug:
        msg: "Successfully connected to {{ inventory_hostname }} - Ready for updates!"

- name: System Update on all machines
  hosts: all
  become: yes
  tasks:
    - name: âœ… Connected to {{ inventory_hostname }}
      debug:
        msg: "Successfully connected to {{ inventory_hostname }} - Updating system now..."

    - name: ğŸ”„ Updating APT Cache on {{ inventory_hostname }}
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: ğŸ› ï¸ Check for any broken packages before upgrading
      command: dpkg --configure -a
      register: dpkg_status
      failed_when: dpkg_status.rc not in [0, 1]
      changed_when: dpkg_status.rc == 0
      when: ansible_os_family == "Debian"

    - name: ğŸš€ Upgrading all packages on {{ inventory_hostname }}
      apt:
        upgrade: full
      when: ansible_os_family == "Debian"

    - name: ğŸ§¹ Cleaning up unused packages on {{ inventory_hostname }}
      apt:
        autoremove: yes
        autoclean: yes
      when: ansible_os_family == "Debian"

    - name: âœ… Update complete on {{ inventory_hostname }}
      debug:
        msg: "Update process completed on {{ inventory_hostname }}"
